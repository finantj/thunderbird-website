const BADGE_CATALOG = [
  {
    name: "Citizenship in the Community",
    focus: "Service project planning, community interviews, and civic participation.",
    length: "4-6 weeks",
    category: "Civic Engagement",
    officialUrl: "https://www.scouting.org/merit-badges/citizenship-in-the-community/",
    pamphletUrl: "https://www.scoutshop.org/citizenship-in-the-community-merit-badge-pamphlet-653216.html",
    requirements: [
      "Discuss with your counselor what it means to be a good citizen in your community, including the rights, responsibilities, and obligations that come with citizenship.",
      "Create or review a map of your community that highlights key government offices, public service agencies, parks, schools, and religious institutions, and explain how each serves residents.",
      "Describe how your local government is organized, name the chief executive and local representatives, and explain how citizens can contact them.",
      "Attend (in person or virtually) a city, town, school board, or county meeting and summarize an issue that was discussed, the viewpoints shared, and any decisions made.",
      "Identify a current issue facing your community, research the stakeholders involved, and share with your counselor how you could help address it as a youth citizen.",
      "Interview a local official or community leader about their responsibilities and how youth can participate in improving the community, then report what you learned.",
      "Choose a community service organization, learn about its mission, and complete at least eight hours of approved volunteer service supporting its work.",
      "Explain how the experience and service you completed demonstrate the principles of good citizenship and describe future ways you can stay engaged in your community."
    ],
  },
  {
    name: "Citizenship in the Nation",
    focus: "National history, constitutional principles, and communicating with elected officials.",
    length: "3-5 weeks",
    category: "Civic Engagement",
    officialUrl: "https://www.scouting.org/merit-badges/citizenship-in-the-nation/",
    pamphletUrl: "https://www.scoutshop.org/citizenship-in-the-nation-merit-badge-pamphlet-653214.html",
    requirements: [
      "Explain what citizenship in the nation means and discuss with your counselor the rights, duties, and obligations of a responsible U.S. citizen.",
      "Describe the purpose of the Declaration of Independence, the Constitution, and the Bill of Rights, and explain how each document protects individual freedoms.",
      "Tell how the three branches of the federal government are organized, name the chief executive and your elected representatives, and describe the system of checks and balances.",
      "Watch or read national news for at least five days and be prepared to discuss a current national issue and how it affects citizens.",
      "Visit (in person or virtually) a place of national historic importance, such as a monument, museum, or national park, and explain what you learned about our nation’s heritage.",
      "Explain the significance of the U.S. flag, the national anthem, and the Pledge of Allegiance, and discuss proper flag etiquette, including how to display, raise, lower, and fold the flag.",
      "Choose a federal agency, historical document, or national service program to research and share how it helps citizens or preserves our democracy.",
      "With your counselor, discuss an issue currently facing the nation and explain how citizens and elected officials can work together to address it."
    ],
  },
  {
    name: "Citizenship in the World",
    focus: "Global awareness, international organizations, and cultural appreciation activities.",
    length: "4-6 weeks",
    category: "Global Citizenship",
    officialUrl: "https://www.scouting.org/merit-badges/citizenship-in-the-world/",
    pamphletUrl: "https://www.scoutshop.org/citizenship-in-the-world-merit-badge-pamphlet-653218.html",
    requirements: [
      "Explain what it means to be a citizen of the world and discuss how you can show good citizenship in your community, nation, and globally.",
      "Describe the differences between a nation, state, and government and explain how international law works between countries.",
      "Identify several international organizations such as the United Nations, World Health Organization, or NATO and explain their purposes and how they serve people around the globe.",
      "Discuss the rights, duties, and obligations of world citizenship and how they compare with the obligations of citizenship in your own country.",
      "Explain how international trade, travel, communications, or cultural exchange can promote peace and understanding among nations.",
      "Choose a current world event or global issue, research multiple viewpoints, and share how it affects other nations and what actions might help improve the situation.",
      "Learn about a country other than your own by studying its history, culture, form of government, and traditions, and present what you discovered to your counselor.",
      "Discuss career and service opportunities in international public service, diplomacy, or global relief work that might be of interest to you."
    ],
  },
  {
    name: "Family Life",
    focus: "Family meetings, responsibilities, and goal planning with trusted adults.",
    length: "3 months",
    category: "Personal Growth",
    officialUrl: "https://www.scouting.org/merit-badges/family-life/",
    pamphletUrl: "https://www.scoutshop.org/family-life-merit-badge-pamphlet-653127.html",
    requirements: [
      "Prepare a written outline of your regular family duties and discuss with your counselor how responsibilities are shared in your home.",
      "Plan and lead a family meeting to talk about goals, schedules, or problem solving, then evaluate how the meeting went and what could be improved.",
      "Discuss with your parents or guardians how your family handles chores, finances, and communication, and describe how you contribute to each area.",
      "Carry out a project that benefits your family, with counselor approval, and keep a record of the planning, time spent, and results.",
      "Choose and complete at least three household duties for 90 consecutive days while tracking your progress and reflecting on the experience.",
      "Plan and carry out a second family meeting focused on setting future goals, making decisions together, or resolving a challenge.",
      "Discuss how families can share values, build healthy relationships, and respond to stress, and explain what you learned from your projects and meetings.",
      "Talk about the roles of family members and how your family’s heritage, traditions, and culture influence your daily life."
    ],
  },
  {
    name: "Personal Fitness",
    focus: "Health assessments, exercise plans, and wellness reflections.",
    length: "3 months",
    category: "Wellness",
    officialUrl: "https://www.scouting.org/merit-badges/personal-fitness/",
    pamphletUrl: "https://www.scoutshop.org/personal-fitness-merit-badge-pamphlet-653190.html",
    requirements: [
      "Before beginning this badge, complete the BSA Annual Health and Medical Record (Parts A and B) with your parent or guardian and a health-care provider.",
      "Explain the components of personal fitness, including physical, mental, emotional, and social health, and describe the benefits of living the Scout Oath and Scout Law in your daily life.",
      "Discuss the importance of good nutrition, rest, and the prevention of substance abuse, and explain how each contributes to lifelong fitness.",
      "Complete a baseline fitness assessment (sit-ups, push-ups, sit-and-reach, one-mile run/walk, and body composition) and record your results.",
      "With your counselor’s approval, develop a 12-week personal fitness program that includes aerobic exercise, strength training, and flexibility work tailored to your goals.",
      "Carry out your 12-week fitness plan, keeping a log of your activities, nutrition choices, and reflections on progress.",
      "Repeat the fitness assessment after 12 weeks and compare your results to your baseline, discussing improvements and future goals with your counselor.",
      "Explain how to respond to injuries or emergencies during physical activity and describe community resources that can help people improve their fitness."
    ],
  },
  {
    name: "Personal Management",
    focus: "Budget tracking, time management, and savings goals.",
    length: "3 months",
    category: "Life Skills",
    officialUrl: "https://www.scouting.org/merit-badges/personal-management/",
    pamphletUrl: "https://www.scoutshop.org/personal-management-merit-badge-pamphlet-653193.html",
    requirements: [
      "Discuss with your counselor what personal management means, why goal setting is important, and how the decisions you make today can affect your future.",
      "Prepare a personal budget that includes income, expenses, and savings goals; track your actual spending for 13 consecutive weeks, and compare the results to your plan.",
      "Explain the concepts of saving, investing, compound interest, and the differences between simple savings accounts, certificates of deposit, stocks, and mutual funds.",
      "Select a major purchase, research the cost, quality, and features of at least three options, and create a plan for earning or saving the money to pay for it.",
      "Discuss the advantages and disadvantages of using credit, loans, and debit cards, and explain how to build and maintain good credit.",
      "Describe different types of insurance (such as health, auto, life, and renter’s) and explain why individuals and families use them.",
      "Explain consumer rights and responsibilities, including how to read contracts, compare warranties, and protect yourself from fraud.",
      "Discuss career planning, education, and training goals with your counselor and describe how you will continue practicing good personal management skills."
    ],
  },
];

const STORAGE_KEY = "thunderbirdScout";

const AUTHORIZED_TROOP_SOURCE = "./data/authorized-troops.json";
let authorizedTroopDiscounts = new Set();
let authorizedTroopPromise = null;
let authorizedTroopListLoaded = false;

let badgeModalElements = null;
let activeBadgeTrigger = null;
let badgeModalKeydownHandler = null;

function normalizeTroopIdentifier(value) {
  if (!value && value !== 0) return "";
  return value
    .toString()
    .trim()
    .toUpperCase()
    .replace(/[^A-Z0-9]/g, "");
}

function isAuthorizedTroop(troopNumber) {
  const normalized = normalizeTroopIdentifier(troopNumber);
  if (!normalized) return false;
  return authorizedTroopDiscounts.has(normalized);
}

async function loadAuthorizedTroopDiscounts() {
  const response = await fetch(AUTHORIZED_TROOP_SOURCE, { cache: "no-store" });
  if (!response.ok) {
    throw new Error(`Unable to load authorized troop list (${response.status})`);
  }
  const data = await response.json();
  let entries = [];
  if (Array.isArray(data)) {
    entries = data;
  } else if (Array.isArray(data.fullScholarship)) {
    entries = data.fullScholarship;
  } else if (Array.isArray(data.troops)) {
    entries = data.troops;
  }
  authorizedTroopDiscounts = new Set(
    entries
      .map((item) => normalizeTroopIdentifier(item))
      .filter((item) => item)
  );
  authorizedTroopListLoaded = true;
  return authorizedTroopDiscounts;
}

function ensureAuthorizedTroopDiscounts() {
  if (!authorizedTroopPromise) {
    authorizedTroopPromise = loadAuthorizedTroopDiscounts().catch((error) => {
      console.warn("Authorized troop scholarship list unavailable", error);
      authorizedTroopDiscounts = new Set();
      authorizedTroopListLoaded = false;
      authorizedTroopPromise = null;
      return authorizedTroopDiscounts;
    });
  }
  return authorizedTroopPromise;
}

function initBadgeModal() {
  const modal = document.querySelector("[data-requirements-modal]");
  if (!modal) return;

  badgeModalElements = {
    container: modal,
    overlay: modal.querySelector("[data-modal-overlay]"),
    title: modal.querySelector("[data-modal-title]"),
    summary: modal.querySelector("[data-modal-summary]"),
    category: modal.querySelector("[data-modal-category]"),
    duration: modal.querySelector("[data-modal-duration]"),
    requirements: modal.querySelector("[data-modal-requirements]"),
    officialLink: modal.querySelector("[data-modal-official]"),
    pamphletLink: modal.querySelector("[data-modal-pamphlet]"),
    closeButton: modal.querySelector("[data-modal-close]"),
  };

  modal.setAttribute("aria-hidden", "true");
  modal.hidden = true;

  if (badgeModalElements.overlay) {
    badgeModalElements.overlay.addEventListener("click", closeBadgeModal);
  }
  if (badgeModalElements.closeButton) {
    badgeModalElements.closeButton.addEventListener("click", closeBadgeModal);
  }
}

function handleBadgeModalKeydown(event) {
  if (event.key === "Escape") {
    event.preventDefault();
    closeBadgeModal();
  }
}

function openBadgeModal(badge, trigger) {
  if (!badgeModalElements) return;

  activeBadgeTrigger = trigger || null;

  if (badgeModalElements.title) {
    badgeModalElements.title.textContent = badge.name;
  }
  if (badgeModalElements.summary) {
    badgeModalElements.summary.textContent = badge.focus;
  }
  if (badgeModalElements.category) {
    badgeModalElements.category.textContent = badge.category;
  }
  if (badgeModalElements.duration) {
    badgeModalElements.duration.textContent = `Typical duration: ${badge.length}`;
  }

  if (badgeModalElements.requirements) {
    badgeModalElements.requirements.innerHTML = "";
    if (Array.isArray(badge.requirements) && badge.requirements.length) {
      badge.requirements.forEach((item) => {
        const li = document.createElement("li");
        li.textContent = item;
        badgeModalElements.requirements.appendChild(li);
      });
    } else {
      const li = document.createElement("li");
      li.textContent = "View the official requirements using the link below.";
      badgeModalElements.requirements.appendChild(li);
    }
  }

  if (badgeModalElements.officialLink) {
    if (badge.officialUrl) {
      badgeModalElements.officialLink.href = badge.officialUrl;
      badgeModalElements.officialLink.textContent = `View ${badge.name} requirements`;
      badgeModalElements.officialLink.classList.remove("visually-hidden");
    } else {
      badgeModalElements.officialLink.classList.add("visually-hidden");
    }
  }

  if (badgeModalElements.pamphletLink) {
    if (badge.pamphletUrl) {
      badgeModalElements.pamphletLink.href = badge.pamphletUrl;
      badgeModalElements.pamphletLink.textContent = `Buy the ${badge.name} pamphlet`;
      badgeModalElements.pamphletLink.classList.remove("visually-hidden");
    } else {
      badgeModalElements.pamphletLink.classList.add("visually-hidden");
    }
  }

  badgeModalElements.container.hidden = false;
  badgeModalElements.container.setAttribute("aria-hidden", "false");
  document.body.classList.add("modal-open");
  badgeModalElements.container.classList.add("modal--visible");

  requestAnimationFrame(() => {
    badgeModalElements.closeButton?.focus();
  });

  badgeModalKeydownHandler = handleBadgeModalKeydown;
  document.addEventListener("keydown", badgeModalKeydownHandler);
}

function closeBadgeModal() {
  if (!badgeModalElements) return;
  badgeModalElements.container.classList.remove("modal--visible");
  badgeModalElements.container.setAttribute("aria-hidden", "true");
  badgeModalElements.container.hidden = true;
  document.body.classList.remove("modal-open");

  if (badgeModalKeydownHandler) {
    document.removeEventListener("keydown", badgeModalKeydownHandler);
    badgeModalKeydownHandler = null;
  }

  if (activeBadgeTrigger && typeof activeBadgeTrigger.focus === "function") {
    activeBadgeTrigger.focus();
  }
  activeBadgeTrigger = null;
}

const currencyFormatter = new Intl.NumberFormat("en-US", {
  style: "currency",
  currency: "USD",
});

const paceLabels = {
  weekly: "Weekly check-ins",
  biweekly: "Every other week",
  monthly: "Monthly",
};

function updateYear() {
  document.querySelectorAll("[data-year]").forEach((node) => {
    node.textContent = new Date().getFullYear();
  });
}

function renderBadgeSelect(container) {
  if (!container) return;
  BADGE_CATALOG.forEach((badge, index) => {
    const id = `badge-${index}`;
    const label = document.createElement("label");
    const checkbox = document.createElement("input");
    const details = document.createElement("div");
    const title = document.createElement("strong");
    const focus = document.createElement("span");

    checkbox.type = "checkbox";
    checkbox.id = id;
    checkbox.name = "badges";
    checkbox.value = badge.name;

    title.textContent = badge.name;
    focus.textContent = badge.focus;
    focus.className = "badge-select__focus";

    label.htmlFor = id;
    details.appendChild(title);
    details.appendChild(document.createElement("br"));
    details.appendChild(focus);

    label.append(checkbox, details);
    container.appendChild(label);
  });
}

function renderBadgeGrid(container) {
  if (!container) return;
  container.innerHTML = "";
  BADGE_CATALOG.forEach((badge) => {
    const card = document.createElement("article");
    card.className = "badge-card";
    card.tabIndex = 0;
    card.setAttribute("role", "button");
    card.setAttribute(
      "aria-label",
      `${badge.name} badge details. Press Enter to view requirements.`
    );

    const title = document.createElement("h3");
    title.textContent = badge.name;

    const tag = document.createElement("span");
    tag.className = "badge-card__tag";
    tag.textContent = badge.category;

    const focus = document.createElement("p");
    focus.textContent = badge.focus;

    const length = document.createElement("p");
    length.innerHTML = `<strong>Typical duration:</strong> ${badge.length}`;

    card.append(title, tag, focus, length);
    card.addEventListener("click", () => openBadgeModal(badge, card));
    card.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        openBadgeModal(badge, card);
      }
    });
    container.appendChild(card);
  });
}

function loadScoutProfile() {
  const stored = window.localStorage?.getItem(STORAGE_KEY);
  if (!stored) return null;
  try {
    return JSON.parse(stored);
  } catch (error) {
    console.error("Unable to parse stored scout profile", error);
    return null;
  }
}

function saveScoutProfile(profile) {
  try {
    window.localStorage?.setItem(STORAGE_KEY, JSON.stringify(profile));
  } catch (error) {
    console.error("Unable to save scout profile", error);
  }
}

function handleLoginForm(form) {
  if (!form) return;
  renderBadgeSelect(form.querySelector("[data-badge-list]"));
  ensureAuthorizedTroopDiscounts();

  form.addEventListener("submit", async (event) => {
    event.preventDefault();

    const formData = new FormData(form);
    const name = formData.get("scoutName")?.toString().trim();
    const troop = formData.get("troop")?.toString().trim();
    const parentEmail = formData.get("parentEmail")?.toString().trim();
    const contactPhone = formData.get("contactPhone")?.toString().trim();
    const pace = formData.get("pace")?.toString();
    const selectedBadges = formData.getAll("badges").map((badge) => badge.toString());

    if (!name || !troop || !parentEmail) {
      form.reportValidity();
      return;
    }

    await ensureAuthorizedTroopDiscounts();

    const normalizedTroop = normalizeTroopIdentifier(troop);
    const scholarshipEligible = isAuthorizedTroop(troop);

    const profile = {
      name,
      troop,
      troopNormalized: normalizedTroop,
      parentEmail,
      contactPhone,
      pace: pace || "weekly",
      createdAt: new Date().toISOString(),
      scholarshipEligible,
      ...(scholarshipEligible ? { scholarshipVerifiedAt: new Date().toISOString() } : {}),
      badges: selectedBadges.map((badgeName) => ({
        name: badgeName,
        progress: badgeName.includes("Citizenship") ? 40 : 10,
        status: "In Progress",
      })),
    };

    if (profile.badges.length === 0) {
      profile.badges.push({
        name: BADGE_CATALOG[0].name,
        progress: 10,
        status: "In Progress",
      });
    }

    saveScoutProfile(profile);
    window.location.href = "./dashboard.html";
  });
}

function createBadgeProgressElement(badge, index, totalBadges) {
  const container = document.createElement("article");
  container.className = "badge-progress";
  container.dataset.badgeIndex = index.toString();

  const header = document.createElement("div");
  header.className = "badge-progress__header";

  const title = document.createElement("h4");
  title.textContent = badge.name;

  const progressLabel = document.createElement("span");
  progressLabel.textContent = `${Math.round(badge.progress)}%`;

  const progress = document.createElement("div");
  progress.className = "progress";

  const bar = document.createElement("div");
  bar.className = "progress__bar";
  bar.style.width = `${Math.min(100, badge.progress)}%`;
  bar.setAttribute("aria-hidden", "true");

  progress.appendChild(bar);

  header.append(title, progressLabel);

  const actions = document.createElement("div");
  actions.className = "badge-progress__actions";

  const advanceButton = document.createElement("button");
  advanceButton.type = "button";
  advanceButton.className = "button button--ghost";
  advanceButton.textContent = "Log Progress (+10%)";
  advanceButton.addEventListener("click", () => updateBadgeProgress(index, 10));

  const completeButton = document.createElement("button");
  completeButton.type = "button";
  completeButton.className = "button";
  completeButton.textContent = "Mark Complete";
  completeButton.addEventListener("click", () => updateBadgeProgress(index, 100));

  const removeButton = document.createElement("button");
  removeButton.type = "button";
  removeButton.className = "button button--ghost";
  removeButton.dataset.action = "remove";
  removeButton.dataset.index = index.toString();
  removeButton.textContent = "Remove Badge";
  removeButton.addEventListener("click", () => removeBadge(index));

  actions.append(advanceButton, completeButton, removeButton);

  if (badge.progress >= 100) {
    const status = document.createElement("span");
    status.className = "badge-card__tag";
    status.textContent = "Complete";
    actions.appendChild(status);
    advanceButton.disabled = true;
    completeButton.disabled = true;
    container.classList.add("badge-progress--complete");
  }

  container.append(header, progress, actions);
  container.dataset.badgeCount = totalBadges.toString();
  return container;
}

function renderDashboard(profile) {
  const emptyState = document.querySelector("[data-dashboard-empty]");
  const content = document.querySelector("[data-dashboard-content]");
  if (!emptyState || !content) return;

  if (!profile) {
    emptyState.hidden = false;
    content.hidden = true;
    return;
  }

  emptyState.hidden = true;
  content.hidden = false;

  const nameField = document.querySelector("[data-scout-name]");
  const troopField = document.querySelector("[data-scout-troop]");
  const paceField = document.querySelector("[data-scout-pace]");

  if (nameField) nameField.textContent = profile.name;
  if (troopField) troopField.textContent = profile.troop;
  if (paceField) paceField.textContent = paceLabels[profile.pace] || "Custom";

  const scholarshipNotice = document.querySelector("[data-scholarship-notice]");
  if (scholarshipNotice) {
    if (profile.scholarshipEligible) {
      let verifiedText = "";
      if (profile.scholarshipVerifiedAt) {
        const verifiedDate = new Date(profile.scholarshipVerifiedAt);
        if (!Number.isNaN(verifiedDate.valueOf())) {
          verifiedText = ` (verified ${verifiedDate.toLocaleDateString(undefined, {
            month: "short",
            day: "numeric",
            year: "numeric",
          })})`;
        }
      }
      scholarshipNotice.innerHTML = `<strong>Foundation sponsored:</strong> badge fees are covered for your troop${verifiedText}.`;
      scholarshipNotice.hidden = false;
    } else {
      scholarshipNotice.hidden = true;
    }
  }

  let badges = [];
  if (Array.isArray(profile.badges)) {
    badges = profile.badges;
  } else {
    profile.badges = [];
    badges = profile.badges;
  }

  const badgeContainer = document.querySelector("[data-badge-progress]");
  if (badgeContainer) {
    badgeContainer.innerHTML = "";
    badges.forEach((badge, index) => {
      badgeContainer.appendChild(createBadgeProgressElement(badge, index, badges.length));
    });
  }

  const addBadgeSelect = document.querySelector("[data-add-badge-form] select");
  if (addBadgeSelect) {
    addBadgeSelect.innerHTML = "";
    const unselectedBadges = BADGE_CATALOG.filter(
      (badge) => !badges.some((item) => item.name === badge.name)
    );
    unselectedBadges.forEach((badge) => {
      const option = document.createElement("option");
      option.value = badge.name;
      option.textContent = badge.name;
      addBadgeSelect.appendChild(option);
    });
    if (!addBadgeSelect.options.length) {
      const option = document.createElement("option");
      option.textContent = "All Eagle-required badges added";
      option.disabled = true;
      addBadgeSelect.appendChild(option);
    }
  }

  updateNextAction(profile);
}

function updateBadgeProgress(index, delta) {
  const profile = loadScoutProfile();
  if (!profile) return;
  if (!Array.isArray(profile.badges)) {
    profile.badges = [];
  }
  const badge = profile.badges[index];
  if (!badge) return;

  if (delta >= 100) {
    badge.progress = 100;
    badge.status = "Complete";
  } else {
    badge.progress = Math.min(100, badge.progress + delta);
    badge.status = badge.progress >= 100 ? "Complete" : "In Progress";
  }

  saveScoutProfile(profile);
  renderDashboard(profile);
}

function updateNextAction(profile) {
  const recommendation = document.querySelector("[data-next-action]");
  if (!recommendation) return;

  const badges = Array.isArray(profile.badges) ? profile.badges : [];

  if (!badges.length) {
    recommendation.textContent = "Add your first badge to unlock personalized guidance.";
    return;
  }

  const inProgress = badges.find((badge) => badge.progress < 100);
  if (!inProgress) {
    recommendation.textContent = "All selected badges are complete! Download your blue card summary and notify your Scoutmaster.";
    return;
  }

  if (inProgress.name.includes("Citizenship")) {
    recommendation.textContent = `Schedule an interview with a community leader for ${inProgress.name}. Use the AI guide to prep your questions.`;
  } else if (inProgress.name === "Personal Fitness") {
    recommendation.textContent = "Log this week's fitness test results and reflect on improvements with the AI coach.";
  } else if (inProgress.name === "Personal Management") {
    recommendation.textContent = "Upload your latest budget tracker and ask the AI mentor to review savings goals.";
  } else {
    recommendation.textContent = `Review your notes for ${inProgress.name} and record a reflection before your next check-in.`;
  }
}

function handleAddBadgeForm() {
  const form = document.querySelector("[data-add-badge-form]");
  if (!form) return;

  form.addEventListener("submit", (event) => {
    event.preventDefault();
    const select = form.querySelector("select");
    if (!select || !select.value) return;

    const profile = loadScoutProfile();
    if (!profile) return;
    if (!Array.isArray(profile.badges)) {
      profile.badges = [];
    }

    const alreadyAdded = profile.badges.some((badge) => badge.name === select.value);
    if (alreadyAdded) return;

    profile.badges.push({ name: select.value, progress: 0, status: "Not Started" });
    saveScoutProfile(profile);
    renderDashboard(profile);
    form.reset();
  });
}

function handleSummaryDownload() {
  const button = document.querySelector("[data-download-summary]");
  if (!button) return;

  button.addEventListener("click", () => {
    const profile = loadScoutProfile();
    if (!profile) return;
    const badges = Array.isArray(profile.badges) ? profile.badges : [];

    const lines = [
      `Scout: ${profile.name} (Troop ${profile.troop})`,
      `Parent/Guardian: ${profile.parentEmail}`,
      "",
      "Badge Progress:",
      ...badges.map((badge) => ` - ${badge.name}: ${Math.round(badge.progress)}% (${badge.status})`),
      "",
      "Generated by Thunderbird Merit Badges",
    ];

    const blob = new Blob([lines.join("\n")], { type: "text/plain" });
    const url = URL.createObjectURL(blob);

    const link = document.createElement("a");
    link.href = url;
    link.download = `${profile.name.replace(/\s+/g, "_")}_badge_summary.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  });
}

function handlePaymentForm(form) {
  if (!form) return;

  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    const summary = document.querySelector("[data-payment-summary]");
    if (!summary) return;

    await ensureAuthorizedTroopDiscounts();

    const formData = new FormData(form);
    const contactName = formData.get("contactName")?.toString().trim();
    const email = formData.get("email")?.toString().trim();
    const badgeCount = Number.parseInt(formData.get("badgeCount"), 10) || 0;
    const discountCode = formData.get("discountCode")?.toString().trim().toUpperCase();

    if (!contactName || !email || badgeCount <= 0) {
      form.reportValidity();
      return;
    }

    const profile = loadScoutProfile();
    const troopNumber = profile?.troopNormalized || profile?.troop;
    const pricing = calculatePricing(badgeCount, discountCode, {
      troopNumber,
      scholarshipEligible: profile?.scholarshipEligible,
    });

    if (profile) {
      const normalized = normalizeTroopIdentifier(troopNumber || profile.troop);
      if (normalized) {
        profile.troopNormalized = normalized;
      }
      if (pricing.scholarshipApplied) {
        profile.scholarshipEligible = true;
        profile.scholarshipVerifiedAt = new Date().toISOString();
      } else if (profile.scholarshipEligible && authorizedTroopListLoaded) {
        if (!isAuthorizedTroop(normalized)) {
          profile.scholarshipEligible = false;
          delete profile.scholarshipVerifiedAt;
        }
      }
      saveScoutProfile(profile);
      renderDashboard(profile);
    }

    const notesText = pricing.notes.length ? pricing.notes.join(", ") : "None";
    const summaryParts = [
      "<h3>Payment summary</h3>",
      `<p><strong>Total due:</strong> ${currencyFormatter.format(pricing.total)}</p>`,
      `<p>We'll send a secure Stripe checkout link to <strong>${email}</strong> with the details below within a few minutes.</p>`,
      "<ul>",
      `<li>Contact: ${contactName}</li>`,
      `<li>Badges requested: ${badgeCount}</li>`,
      `<li>Discounts applied: ${notesText}</li>`,
      "</ul>",
    ];

    if (pricing.scholarshipApplied) {
      summaryParts.push(
        '<p class="payment-summary__highlight">No payment required — your troop is covered by a foundation scholarship.</p>'
      );
    }

    summary.innerHTML = summaryParts.join("\n");
  });
}

function calculatePricing(badgeCount, discountCode, options = {}) {
  let total = badgeCount * 20;
  const notes = [];
  const { troopNumber, scholarshipEligible } = options;
  const hasScholarship = Boolean(scholarshipEligible) || isAuthorizedTroop(troopNumber);

  if (hasScholarship) {
    notes.push("Foundation scholarship (100% off)");
    return { total: 0, notes, scholarshipApplied: true };
  }

  if (badgeCount >= 5) {
    const bundleTotal = Math.round(badgeCount * 20 * 0.85 * 100) / 100;
    notes.push("Troop bundle (15% off)");
    total = bundleTotal;
  }

  if (discountCode === "EAGLEDUO") {
    total = Math.round(total * 0.9 * 100) / 100;
    notes.push("Eagle Duo 10% savings");
  }

  return { total, notes, scholarshipApplied: false };
}

function initPage() {
  updateYear();
  ensureAuthorizedTroopDiscounts();
  handleLoginForm(document.querySelector("[data-login-form]"));
  initBadgeModal();
  renderBadgeGrid(document.querySelector("[data-badge-grid]"));
  const profile = loadScoutProfile();
  renderDashboard(profile);
  handleAddBadgeForm();
  handleSummaryDownload();
  handlePaymentForm(document.querySelector("[data-payment-form]"));
}

function removeBadge(index) {
  const profile = loadScoutProfile();
  if (!profile) return;
  if (!Array.isArray(profile.badges)) {
    profile.badges = [];
  }
  profile.badges.splice(index, 1);
  saveScoutProfile(profile);
  renderDashboard(profile);
}

document.addEventListener("DOMContentLoaded", initPage);
